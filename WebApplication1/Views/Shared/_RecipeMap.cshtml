@* Partial view: Mapa interactivo de lotes y puntos sensibles *@
@* Requiere que el modelo padre tenga Recipe con Lots y SensitivePoints *@

@{
    var recipe = ViewData["Recipe"] as WebApplication1.Models.Recipes.RecipeDetailDto;
    if (recipe == null) return;

    var hasLots = recipe.Lots != null && recipe.Lots.Any(l => l.Vertices != null && l.Vertices.Any());
    var hasSensitivePoints = recipe.SensitivePoints != null && recipe.SensitivePoints.Any();

    if (!hasLots && !hasSensitivePoints) return;
}

<section class="detail-section">
    <h2 class="section-title">
        <span class="section-icon">üó∫Ô∏è</span> Mapa de Lotes y Puntos Sensibles
    </h2>

    <div id="recipe-map" style="height: 450px; border-radius: 12px; border: 1px solid #e0e0e0; z-index: 0;"></div>

    <div class="map-legend" style="display: flex; gap: 20px; margin-top: 10px; font-size: 13px; color: #555; flex-wrap: wrap;">
        @if (hasLots)
        {
            <span>üü¶ <strong>Lotes</strong> (pol√≠gonos)</span>
        }
        @if (hasSensitivePoints)
        {
            <span>üî¥ <strong>Puntos sensibles</strong> (marcadores)</span>
        }
    </div>
</section>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    (function () {
        var map = L.map('recipe-map');

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
            maxZoom: 19
        }).addTo(map);

        var bounds = L.latLngBounds();
        var lotColors = ['#3388ff', '#28a745', '#e67e22', '#9b59b6', '#e74c3c', '#1abc9c', '#f39c12', '#2980b9'];
        var colorIndex = 0;

        @if (hasLots)
        {
            @foreach (var lot in recipe.Lots.Where(l => l.Vertices != null && l.Vertices.Any()))
            {
                var vertices = lot.Vertices.OrderBy(v => v.Order).ToList();
                <text>
                // Lote: @lot.LotName
                (function () {
                    var coords = [
                        @foreach (var v in vertices)
                        {
                            @:[@v.Latitude.ToString(System.Globalization.CultureInfo.InvariantCulture), @v.Longitude.ToString(System.Globalization.CultureInfo.InvariantCulture)],
                        }
                    ];

                    var color = lotColors[colorIndex % lotColors.length];
                    colorIndex++;

                    var polygon = L.polygon(coords, {
                        color: color,
                        weight: 3,
                        fillOpacity: 0.15,
                        fillColor: color
                    }).addTo(map);

                    var popupHtml = '<strong>@Html.Raw(lot.LotName?.Replace("'", "\\'") ?? "")</strong>';
                    @if (!string.IsNullOrEmpty(lot.Locality))
                    {
                        @:popupHtml += '<br>Localidad: @Html.Raw(lot.Locality.Replace("'", "\\'"))';
                    }
                    @if (!string.IsNullOrEmpty(lot.Department))
                    {
                        @:popupHtml += '<br>Departamento: @Html.Raw(lot.Department.Replace("'", "\\'"))';
                    }
                    @if (lot.SurfaceHa.HasValue)
                    {
                        @:popupHtml += '<br>Superficie: @lot.SurfaceHa.Value.ToString("N2") ha';
                    }
                    popupHtml += '<br>V√©rtices: @vertices.Count';

                    polygon.bindPopup(popupHtml);

                    coords.forEach(function (c) { bounds.extend(c); });
                })();
                </text>
            }
        }

        @if (hasSensitivePoints)
        {
            @foreach (var sp in recipe.SensitivePoints)
            {
                <text>
                (function () {
                    var lat = @sp.Latitude.ToString(System.Globalization.CultureInfo.InvariantCulture);
                    var lng = @sp.Longitude.ToString(System.Globalization.CultureInfo.InvariantCulture);

                    var icon = L.divIcon({
                        html: '<div style="background:#e74c3c; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 1px 3px rgba(0,0,0,0.4);"></div>',
                        className: '',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8],
                        popupAnchor: [0, -10]
                    });

                    var marker = L.marker([lat, lng], { icon: icon }).addTo(map);

                    var popupHtml = '<strong style="color:#e74c3c;">‚ö†Ô∏è @Html.Raw(sp.Name?.Replace("'", "\\'") ?? "")</strong>';
                    @if (!string.IsNullOrEmpty(sp.Type))
                    {
                        @:popupHtml += '<br>Tipo: @Html.Raw(sp.Type.Replace("'", "\\'"))';
                    }
                    @if (!string.IsNullOrEmpty(sp.Locality))
                    {
                        @:popupHtml += '<br>Localidad: @Html.Raw(sp.Locality.Replace("'", "\\'"))';
                    }
                    @if (!string.IsNullOrEmpty(sp.Department))
                    {
                        @:popupHtml += '<br>Departamento: @Html.Raw(sp.Department.Replace("'", "\\'"))';
                    }

                    marker.bindPopup(popupHtml);

                    bounds.extend([lat, lng]);
                })();
                </text>
            }
        }

        if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [40, 40], maxZoom: 15 });
        } else {
            map.setView([-33.0, -61.0], 8);
        }
    })();
</script>
