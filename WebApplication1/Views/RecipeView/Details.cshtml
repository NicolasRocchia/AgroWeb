@model WebApplication1.Models.Recipes.RecipeDetailViewModel
@{
    ViewData["Title"] = $"Receta RFD #{Model.Recipe.RfdNumber}";
}

<!-- Header Sticky -->
<div class="detail-header">
    <div class="detail-header-content">
        <a asp-action="Index" class="back-button">
            ‚Üê Volver a Mis Recetas
        </a>
        <h1 class="detail-title">
            RFD #@Model.Recipe.RfdNumber
        </h1>
        <div class="detail-meta">
            @{
                var statusClass = Model.Recipe.Status?.ToUpper() switch
                {
                    "ABIERTA" => "status-approved",
                    "CERRADA" => "status-expired",
                    "ANULADA" => "status-rejected",
                    _ => "status-draft"
                };
            }
            <span class="status-badge @statusClass">
                @Model.Recipe.Status
            </span>
        </div>
    </div>
</div>

<!-- Contenido Principal -->
<div class="detail-container">

    @if (ViewBag.Error != null)
    {
        <div class="alert-error">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <div>
                <strong>Error:</strong> @ViewBag.Error
            </div>
        </div>
    }

    <!-- Informaci√≥n General -->
    <section class="detail-section">
        <h2 class="section-title">
            <span class="section-icon">üìÑ</span> Informaci√≥n General
        </h2>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Fecha de Emisi√≥n</span>
                <span class="info-value">@Model.Recipe.IssueDate.ToString("dd/MM/yyyy")</span>
            </div>
            <div class="info-item">
                <span class="info-label">Inicio Posible</span>
                <span class="info-value @(Model.Recipe.PossibleStartDate == null ? "empty" : "")">
                    @(Model.Recipe.PossibleStartDate?.ToString("dd/MM/yyyy") ?? "No especificado")
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Fecha Recomendada</span>
                <span class="info-value @(Model.Recipe.RecommendedDate == null ? "empty" : "")">
                    @(Model.Recipe.RecommendedDate?.ToString("dd/MM/yyyy") ?? "No especificada")
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Fecha de Vencimiento</span>
                <span class="info-value @(Model.Recipe.ExpirationDate == null ? "empty" : "")">
                    @(Model.Recipe.ExpirationDate?.ToString("dd/MM/yyyy") ?? "No especificado")
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Tipo de Aplicaci√≥n</span>
                <span class="info-value">@(Model.Recipe.ApplicationType ?? "No especificado")</span>
            </div>
            <div class="info-item">
                <span class="info-label">Cultivo</span>
                <span class="info-value">@(Model.Recipe.Crop ?? "No especificado")</span>
            </div>
            <div class="info-item">
                <span class="info-label">Superficie Unitaria</span>
                <span class="info-value">
                    @(Model.Recipe.UnitSurfaceHa.HasValue ? $"{Model.Recipe.UnitSurfaceHa:N2} ha" : "No especificada")
                </span>
            </div>
        </div>
    </section>

    <!-- Diagn√≥stico y Tratamiento -->
    @if (!string.IsNullOrEmpty(Model.Recipe.Diagnosis) || !string.IsNullOrEmpty(Model.Recipe.Treatment))
    {
        <section class="detail-section">
            <h2 class="section-title">
                <span class="section-icon">üî¨</span> Diagn√≥stico y Tratamiento
            </h2>
            <div class="card-content">
                @if (!string.IsNullOrEmpty(Model.Recipe.Diagnosis))
                {
                    <p><strong>Diagn√≥stico:</strong></p>
                    <p style="white-space: pre-wrap; margin-left: 20px;">@Model.Recipe.Diagnosis</p>
                }
                @if (!string.IsNullOrEmpty(Model.Recipe.Treatment))
                {
                    <p><strong>Tratamiento:</strong></p>
                    <p style="white-space: pre-wrap; margin-left: 20px;">@Model.Recipe.Treatment</p>
                }
            </div>
        </section>
    }

    <!-- Solicitante -->
    <section class="detail-section">
        <h2 class="section-title">
            <span class="section-icon">üë§</span> Solicitante
        </h2>
        <div class="card-content">
            <p><strong>Raz√≥n Social:</strong> @Model.Recipe.Requester.LegalName</p>
            <p><strong>CUIT:</strong> @Model.Recipe.Requester.TaxId</p>
        </div>
    </section>

    <!-- Asesor -->
    <section class="detail-section">
        <h2 class="section-title">
            <span class="section-icon">üë®‚Äçüî¨</span> Asesor Fitosanitario
        </h2>
        <div class="card-content">
            <p><strong>Nombre Completo:</strong> @Model.Recipe.Advisor.FullName</p>
            <p><strong>Matr√≠cula:</strong> @Model.Recipe.Advisor.LicenseNumber</p>
        </div>
    </section>

    <!-- Condiciones Ambientales -->
    @if (Model.Recipe.TempMin.HasValue || Model.Recipe.TempMax.HasValue ||
        Model.Recipe.HumidityMin.HasValue || Model.Recipe.HumidityMax.HasValue ||
        Model.Recipe.WindMinKmh.HasValue || Model.Recipe.WindMaxKmh.HasValue ||
        !string.IsNullOrEmpty(Model.Recipe.WindDirection))
    {
        <section class="detail-section">
            <h2 class="section-title">
                <span class="section-icon">üå§Ô∏è</span> Condiciones Ambientales
            </h2>
            <div class="info-grid">
                @if (Model.Recipe.TempMin.HasValue || Model.Recipe.TempMax.HasValue)
                {
                    <div class="info-item">
                        <span class="info-label">Temperatura</span>
                        <span class="info-value">@Model.Recipe.TempMin¬∞C - @Model.Recipe.TempMax¬∞C</span>
                    </div>
                }
                @if (Model.Recipe.HumidityMin.HasValue || Model.Recipe.HumidityMax.HasValue)
                {
                    <div class="info-item">
                        <span class="info-label">Humedad</span>
                        <span class="info-value">@Model.Recipe.HumidityMin% - @Model.Recipe.HumidityMax%</span>
                    </div>
                }
                @if (Model.Recipe.WindMinKmh.HasValue || Model.Recipe.WindMaxKmh.HasValue)
                {
                    <div class="info-item">
                        <span class="info-label">Viento</span>
                        <span class="info-value">@Model.Recipe.WindMinKmh - @Model.Recipe.WindMaxKmh km/h</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(Model.Recipe.WindDirection))
                {
                    <div class="info-item">
                        <span class="info-label">Direcci√≥n del Viento</span>
                        <span class="info-value">@Model.Recipe.WindDirection</span>
                    </div>
                }
            </div>
        </section>
    }

    <!-- Productos -->
    <section class="detail-section">
        <h2 class="section-title">
            <span class="section-icon">üß™</span> Productos (@Model.Recipe.Products.Count)
        </h2>

        @if (Model.Recipe.Products.Any())
        {
            <div class="products-container">
                @foreach (var product in Model.Recipe.Products)
                {
                    <div class="product-card">
                        <div class="product-header">
                            <span class="product-name">@product.ProductName</span>
                            @if (product.DoseValue.HasValue)
                            {
                                <span class="product-dose">
                                    @product.DoseValue.Value.ToString("N2") @(product.DoseUnit ?? "")
                                </span>
                            }
                        </div>
                        <div class="product-details">
                            @if (!string.IsNullOrEmpty(product.SenasaRegistry))
                            {
                                <div class="product-detail-item">
                                    <span class="detail-label">SENASA</span>
                                    <span class="detail-value">@product.SenasaRegistry</span>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(product.ToxicologicalClass))
                            {
                                <div class="product-detail-item">
                                    <span class="detail-label">Clase Toxicol√≥gica</span>
                                    <span class="detail-value">@product.ToxicologicalClass</span>
                                </div>
                            }
                            @if (product.TotalValue.HasValue)
                            {
                                <div class="product-detail-item">
                                    <span class="detail-label">Total</span>
                                    <span class="detail-value">@product.TotalValue.Value.ToString("N2") @(product.TotalUnit ?? "")</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state-detail">
                <div class="empty-icon-large">üì¶</div>
                <h3>No hay productos registrados</h3>
            </div>
        }
    </section>

    <!-- Lotes -->
    <section class="detail-section">
        <h2 class="section-title">
            <span class="section-icon">üó∫Ô∏è</span> Lotes (@Model.Recipe.Lots.Count)
        </h2>

        @if (Model.Recipe.Lots.Any())
        {
            <div class="lots-container">
                @foreach (var lot in Model.Recipe.Lots)
                {
                    <div class="lot-card">
                        <div class="lot-header">
                            <span class="lot-icon">üìç</span>
                            @lot.LotName
                        </div>
                        <div class="lot-details">
                            @if (!string.IsNullOrEmpty(lot.Locality))
                            {
                                <p><strong>Localidad:</strong> @lot.Locality</p>
                            }
                            @if (!string.IsNullOrEmpty(lot.Department))
                            {
                                <p><strong>Departamento:</strong> @lot.Department</p>
                            }
                            @if (lot.SurfaceHa.HasValue)
                            {
                                <p><strong>Superficie:</strong> @lot.SurfaceHa.Value.ToString("N2") ha</p>
                            }
                            @if (lot.Vertices != null && lot.Vertices.Any())
                            {
                                <details style="margin-top: 8px;">
                                    <summary style="cursor: pointer; color: #667eea; font-weight: 600;">
                                        Ver @lot.Vertices.Count coordenadas
                                    </summary>
                                    <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px;">
                                        @foreach (var vertex in lot.Vertices.OrderBy(v => v.Order))
                                        {
                                            <li>Punto @vertex.Order: @vertex.Latitude.ToString("F6"), @vertex.Longitude.ToString("F6")</li>
                                        }
                                    </ul>
                                </details>
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state-detail">
                <div class="empty-icon-large">üó∫Ô∏è</div>
                <h3>No hay lotes registrados</h3>
            </div>
        }
    </section>

    <!-- Notas -->
    @if (!string.IsNullOrEmpty(Model.Recipe.Notes))
    {
        <section class="detail-section">
            <h2 class="section-title">
                <span class="section-icon">üìù</span> Notas
            </h2>
            <div class="card-content">
                <p style="white-space: pre-wrap;">@Model.Recipe.Notes</p>
            </div>
        </section>
    }
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/recipeDetail.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/recipes.css" asp-append-version="true" />
}
