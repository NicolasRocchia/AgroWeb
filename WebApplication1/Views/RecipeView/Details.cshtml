@model WebApplication1.Models.Recipes.RecipeDetailViewModel
@{
    ViewData["Title"] = $"Receta RFD #{Model.Recipe.RfdNumber}";
}

<!-- Header Sticky -->
<div class="detail-header">
    <div class="detail-header-content">
        <a asp-action="Index" class="back-button">
            ‚Üê Volver a Mis Recetas
        </a>
        <h1 class="detail-title">
            RFD #@Model.Recipe.RfdNumber
        </h1>
        <div class="detail-meta">
            @{
                var statusClass = Model.Recipe.Status?.ToUpper() switch
                {
                    "ABIERTA" => "status-approved",
                    "PENDIENTE" => "status-draft",
                    "APROBADA" => "status-approved",
                    "RECHAZADA" => "status-rejected",
                    "OBSERVADA" => "status-warning",
                    "CERRADA" => "status-expired",
                    "ANULADA" => "status-rejected",
                    _ => "status-draft"
                };
            }
            <span class="status-badge @statusClass">
                @Model.Recipe.Status
            </span>
        </div>
    </div>
</div>

<!-- Contenido Principal -->
<div class="detail-container">

    @if (TempData["Success"] != null)
    {
        <div class="alert-success" style="background: #ecfdf5; border: 1px solid #6ee7b7; border-radius: 10px; padding: 14px 20px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; color: #065f46;">
            <span>‚úÖ</span>
            <span>@TempData["Success"]</span>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert-error">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <div>
                <strong>Error:</strong> @TempData["Error"]
            </div>
        </div>
    }

    @if (ViewBag.Error != null)
    {
        <div class="alert-error">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <div>
                <strong>Error:</strong> @ViewBag.Error
            </div>
        </div>
    }

    <!-- Acciones de Estado -->
    @{
        var st = Model.Recipe.Status?.ToUpper();
    }
    @if (st == "ABIERTA" || st == "APROBADA" || st == "RECHAZADA" || st == "OBSERVADA")
    {
        <section class="detail-section" style="background: #f8fafc; border: 2px dashed #cbd5e1;">
            <h2 class="section-title">
                <span class="section-icon">‚ö°</span> Acciones
            </h2>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                @if (st == "ABIERTA")
                {
                    <a href="@Url.Action("AssignMunicipality", "RecipeView", new { id = Model.Recipe.Id })"
                       class="btn-status" style="background: #eff6ff; color: #1e40af; border: 2px solid #93c5fd; text-decoration: none;">
                        üì§ Enviar a Municipio
                    </a>
                    <form asp-action="ChangeStatus" method="post" style="margin: 0;"
                          onsubmit="return confirm('¬øCerrar esta receta sin enviarla a un municipio?');">
                        <input type="hidden" name="id" value="@Model.Recipe.Id" />
                        <input type="hidden" name="status" value="CERRADA" />
                        <button type="submit" class="btn-status btn-cerrar">‚úÖ Cerrar Receta</button>
                    </form>
                    <form asp-action="ChangeStatus" method="post" style="margin: 0;"
                          onsubmit="return confirm('¬øAnular esta receta?');">
                        <input type="hidden" name="id" value="@Model.Recipe.Id" />
                        <input type="hidden" name="status" value="ANULADA" />
                        <button type="submit" class="btn-status btn-anular">‚ùå Anular Receta</button>
                    </form>
                }
                @if (st == "APROBADA")
                {
                    <form asp-action="ChangeStatus" method="post" style="margin: 0;"
                          onsubmit="return confirm('¬øConfirmar que la aplicaci√≥n fue realizada?');">
                        <input type="hidden" name="id" value="@Model.Recipe.Id" />
                        <input type="hidden" name="status" value="CERRADA" />
                        <button type="submit" class="btn-status btn-cerrar">‚úÖ Cerrar Receta (Aplicada)</button>
                    </form>
                }
                @if (st == "RECHAZADA")
                {
                    <form asp-action="ChangeStatus" method="post" style="margin: 0;"
                          onsubmit="return confirm('¬øAnular esta receta rechazada?');">
                        <input type="hidden" name="id" value="@Model.Recipe.Id" />
                        <input type="hidden" name="status" value="ANULADA" />
                        <button type="submit" class="btn-status btn-anular">‚ùå Anular Receta</button>
                    </form>
                }
            </div>
        </section>
    }

    <!-- Estado Municipal -->
    @if (Model.Recipe.AssignedMunicipalityId.HasValue)
    {
        <section class="detail-section" style="background: #eff6ff; border-left: 4px solid #3b82f6;">
            <h2 class="section-title">
                <span class="section-icon">üèõÔ∏è</span> Control Municipal
            </h2>
            <div class="info-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="info-item">
                    <span class="info-label">Municipio asignado</span>
                    <span class="info-value">@Model.Recipe.AssignedMunicipalityName</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Enviada el</span>
                    <span class="info-value">@Model.Recipe.AssignedAt?.ToString("dd/MM/yyyy HH:mm")</span>
                </div>
            </div>

            @if (Model.Recipe.ReviewLogs?.Any() == true)
            {
                <h3 style="margin: 16px 0 8px; font-size: 14px; color: #475569;">Historial de revisiones</h3>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    @foreach (var log in Model.Recipe.ReviewLogs)
                    {
                        var actionColor = log.Action switch {
                            "APROBADA" => "#16a34a",
                            "RECHAZADA" => "#dc2626",
                            "OBSERVADA" => "#d97706",
                            "REDIRIGIDA" => "#2563eb",
                            _ => "#64748b"
                        };
                        var actionIcon = log.Action switch {
                            "APROBADA" => "‚úÖ",
                            "RECHAZADA" => "‚ùå",
                            "OBSERVADA" => "üí¨",
                            "REDIRIGIDA" => "‚Ü™Ô∏è",
                            _ => "‚Ä¢"
                        };
                        <div style="padding: 10px 14px; background: white; border-radius: 8px; border-left: 3px solid @actionColor;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600; color: @actionColor;">@actionIcon @log.Action</span>
                                <span style="font-size: 12px; color: #94a3b8;">@log.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                            </div>
                            <div style="font-size: 13px; color: #64748b;">@log.MunicipalityName</div>
                            @if (log.Action == "REDIRIGIDA" && !string.IsNullOrEmpty(log.TargetMunicipalityName))
                            {
                                <div style="font-size: 13px; color: #2563eb;">‚Üí @log.TargetMunicipalityName</div>
                            }
                            @if (!string.IsNullOrEmpty(log.Observation))
                            {
                                <div style="margin-top: 6px; font-size: 13px; color: #334155; background: #f8fafc; padding: 8px; border-radius: 6px;">@log.Observation</div>
                            }
                        </div>
                    }
                </div>
            }
        </section>
    }

    <!-- Mensajes -->
    @if (Model.Recipe.Messages?.Any() == true || st == "OBSERVADA")
    {
        <section class="detail-section">
            <h2 class="section-title">
                <span class="section-icon">üí¨</span> Mensajes
            </h2>

            @if (Model.Recipe.Messages?.Any() == true)
            {
                <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; max-height: 400px; overflow-y: auto;">
                    @foreach (var msg in Model.Recipe.Messages)
                    {
                        var isMe = msg.SenderRole == "Aplicador";
                        <div style="align-self: @(isMe ? "flex-end" : "flex-start"); max-width: 80%; padding: 10px 14px; border-radius: 12px; background: @(isMe ? "#dcfce7" : "#f1f5f9");">
                            <div style="font-size: 12px; font-weight: 600; color: @(isMe ? "#166534" : "#1e40af"); margin-bottom: 4px;">
                                @msg.SenderName (@msg.SenderRole)
                            </div>
                            <div style="font-size: 14px; color: #1e293b;">@msg.Message</div>
                            <div style="font-size: 11px; color: #94a3b8; text-align: right; margin-top: 4px;">
                                @msg.CreatedAt.ToString("dd/MM HH:mm")
                            </div>
                        </div>
                    }
                </div>
            }

            @if (st == "OBSERVADA")
            {
                <form asp-action="SendMessage" method="post" style="display: flex; gap: 8px;">
                    <input type="hidden" name="id" value="@Model.Recipe.Id" />
                    <input type="text" name="message" required maxlength="1000"
                           placeholder="Respond√© al municipio..."
                           style="flex: 1; padding: 10px 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px;" />
                    <button type="submit" class="btn-status btn-cerrar" style="white-space: nowrap;">
                        Enviar üì©
                    </button>
                </form>
                <p style="font-size: 12px; color: #94a3b8; margin-top: 6px;">
                    Al responder, la receta volver√° al estado PENDIENTE para que el municipio la revise.
                </p>
            }
        </section>
    }

    <!-- Informaci√≥n General -->
    <section class="detail-section">
        <h2 class="section-title">
            <span class="section-icon">üìÑ</span> Informaci√≥n General
        </h2>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Fecha de Emisi√≥n</span>
                <span class="info-value">@Model.Recipe.IssueDate.ToString("dd/MM/yyyy")</span>
            </div>
            <div class="info-item">
                <span class="info-label">Inicio Posible</span>
                <span class="info-value @(Model.Recipe.PossibleStartDate == null ? "empty" : "")">
                    @(Model.Recipe.PossibleStartDate?.ToString("dd/MM/yyyy") ?? "No especificado")
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Fecha Recomendada</span>
                <span class="info-value @(Model.Recipe.RecommendedDate == null ? "empty" : "")">
                    @(Model.Recipe.RecommendedDate?.ToString("dd/MM/yyyy") ?? "No especificada")
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Fecha de Vencimiento</span>
                <span class="info-value @(Model.Recipe.ExpirationDate == null ? "empty" : "")">
                    @(Model.Recipe.ExpirationDate?.ToString("dd/MM/yyyy") ?? "No especificado")
                </span>
            </div>
            <div class="info-item">
                <span class="info-label">Tipo de Aplicaci√≥n</span>
                <span class="info-value">@(Model.Recipe.ApplicationType ?? "No especificado")</span>
            </div>
            <div class="info-item">
                <span class="info-label">Cultivo</span>
                <span class="info-value">@(Model.Recipe.Crop ?? "No especificado")</span>
            </div>
            <div class="info-item">
                <span class="info-label">Superficie Unitaria</span>
                <span class="info-value">
                    @(Model.Recipe.UnitSurfaceHa.HasValue ? $"{Model.Recipe.UnitSurfaceHa:N2} ha" : "No especificada")
                </span>
            </div>
        </div>
    </section>

    <!-- Diagn√≥stico y Tratamiento -->
    @if (!string.IsNullOrEmpty(Model.Recipe.Diagnosis) || !string.IsNullOrEmpty(Model.Recipe.Treatment))
    {
        <section class="detail-section">
            <h2 class="section-title">
                <span class="section-icon">üî¨</span> Diagn√≥stico y Tratamiento
            </h2>
            <div class="card-content">
                @if (!string.IsNullOrEmpty(Model.Recipe.Diagnosis))
                {
                    <p><strong>Diagn√≥stico:</strong></p>
                    <p style="white-space: pre-wrap; margin-left: 20px;">@Model.Recipe.Diagnosis</p>
                }
                @if (!string.IsNullOrEmpty(Model.Recipe.Treatment))
                {
                    <p><strong>Tratamiento:</strong></p>
                    <p style="white-space: pre-wrap; margin-left: 20px;">@Model.Recipe.Treatment</p>
                }
            </div>
        </section>
    }

    <!-- Solicitante -->
    <section class="detail-section">
        <h2 class="section-title">
            <span class="section-icon">üë§</span> Solicitante
        </h2>
        <div class="card-content">
            <p><strong>Raz√≥n Social:</strong> @Model.Recipe.Requester.LegalName</p>
            <p><strong>CUIT:</strong> @Model.Recipe.Requester.TaxId</p>
        </div>
    </section>

    <!-- Asesor -->
    <section class="detail-section">
        <h2 class="section-title">
            <span class="section-icon">üë®‚Äçüî¨</span> Asesor Fitosanitario
        </h2>
        <div class="card-content">
            <p><strong>Nombre Completo:</strong> @Model.Recipe.Advisor.FullName</p>
            <p><strong>Matr√≠cula:</strong> @Model.Recipe.Advisor.LicenseNumber</p>
        </div>
    </section>

    <!-- Condiciones Ambientales -->
    @if (Model.Recipe.TempMin.HasValue || Model.Recipe.TempMax.HasValue ||
        Model.Recipe.HumidityMin.HasValue || Model.Recipe.HumidityMax.HasValue ||
        Model.Recipe.WindMinKmh.HasValue || Model.Recipe.WindMaxKmh.HasValue ||
        !string.IsNullOrEmpty(Model.Recipe.WindDirection))
    {
        <section class="detail-section">
            <h2 class="section-title">
                <span class="section-icon">üå§Ô∏è</span> Condiciones Ambientales
            </h2>
            <div class="info-grid">
                @if (Model.Recipe.TempMin.HasValue || Model.Recipe.TempMax.HasValue)
                {
                    <div class="info-item">
                        <span class="info-label">Temperatura</span>
                        <span class="info-value">@Model.Recipe.TempMin¬∞C - @Model.Recipe.TempMax¬∞C</span>
                    </div>
                }
                @if (Model.Recipe.HumidityMin.HasValue || Model.Recipe.HumidityMax.HasValue)
                {
                    <div class="info-item">
                        <span class="info-label">Humedad</span>
                        <span class="info-value">@Model.Recipe.HumidityMin% - @Model.Recipe.HumidityMax%</span>
                    </div>
                }
                @if (Model.Recipe.WindMinKmh.HasValue || Model.Recipe.WindMaxKmh.HasValue)
                {
                    <div class="info-item">
                        <span class="info-label">Viento</span>
                        <span class="info-value">@Model.Recipe.WindMinKmh - @Model.Recipe.WindMaxKmh km/h</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(Model.Recipe.WindDirection))
                {
                    <div class="info-item">
                        <span class="info-label">Direcci√≥n del Viento</span>
                        <span class="info-value">@Model.Recipe.WindDirection</span>
                    </div>
                }
            </div>
        </section>
    }

    <!-- Pron√≥stico Clim√°tico -->
    @{
        ViewData["Recipe"] = Model.Recipe;
    }
    @await Html.PartialAsync("_WeatherForecast")

    <!-- Productos -->
    <section class="detail-section">
        <h2 class="section-title">
            <span class="section-icon">üß™</span> Productos (@Model.Recipe.Products.Count)
        </h2>

        @if (Model.Recipe.Products.Any())
        {
            <div class="products-container">
                @foreach (var product in Model.Recipe.Products)
                {
                    @await Html.PartialAsync("_ProductCard", product)
                }
            </div>
        }
        else
        {
            <div class="empty-state-detail">
                <div class="empty-icon-large">üì¶</div>
                <h3>No hay productos registrados</h3>
            </div>
        }
    </section>

    <!-- Lotes -->
    <section class="detail-section">
        <h2 class="section-title">
            <span class="section-icon">üó∫Ô∏è</span> Lotes (@Model.Recipe.Lots.Count)
        </h2>

        @if (Model.Recipe.Lots.Any())
        {
            <div class="lots-container">
                @foreach (var lot in Model.Recipe.Lots)
                {
                    <div class="lot-card">
                        <div class="lot-header">
                            <span class="lot-icon">üìç</span>
                            @lot.LotName
                        </div>
                        <div class="lot-details">
                            @if (!string.IsNullOrEmpty(lot.Locality))
                            {
                                <p><strong>Localidad:</strong> @lot.Locality</p>
                            }
                            @if (!string.IsNullOrEmpty(lot.Department))
                            {
                                <p><strong>Departamento:</strong> @lot.Department</p>
                            }
                            @if (lot.SurfaceHa.HasValue)
                            {
                                <p><strong>Superficie:</strong> @lot.SurfaceHa.Value.ToString("N2") ha</p>
                            }
                            @if (lot.Vertices != null && lot.Vertices.Any())
                            {
                                <details style="margin-top: 8px;">
                                    <summary style="cursor: pointer; color: #667eea; font-weight: 600;">
                                        Ver @lot.Vertices.Count coordenadas
                                    </summary>
                                    <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px;">
                                        @foreach (var vertex in lot.Vertices.OrderBy(v => v.Order))
                                        {
                                            <li>Punto @vertex.Order: @vertex.Latitude.ToString("F6"), @vertex.Longitude.ToString("F6")</li>
                                        }
                                    </ul>
                                </details>
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state-detail">
                <div class="empty-icon-large">üó∫Ô∏è</div>
                <h3>No hay lotes registrados</h3>
            </div>
        }
    </section>

    <!-- Mapa Interactivo -->
    @await Html.PartialAsync("_RecipeMap")

    <!-- Notas -->
    @if (!string.IsNullOrEmpty(Model.Recipe.Notes))
    {
        <section class="detail-section">
            <h2 class="section-title">
                <span class="section-icon">üìù</span> Notas
            </h2>
            <div class="card-content">
                <p style="white-space: pre-wrap;">@Model.Recipe.Notes</p>
            </div>
        </section>
    }
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/recipeDetail.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/recipes.css" asp-append-version="true" />
}
